<!DOCTYPE html>
<html>
  <head>
    <%- include('partials/head.ejs'); %>
    <title>Reports</title>
  </head>
  <body id="main">
    <div class="container">
      <%- include('partials/navbar.ejs'); %>
      <div class="right-column">
        <%- include('partials/header.ejs'); %>
        <!-- Mockup for reports page which includes daily, weekly, monthly, & yearly sales totals -->

        <!-- This creates sales and services tabs -->
        <div class="bottomrow">
          <ul class="nav nav-tabs">
            <li class="nav-item">
              <a class="nav-link active" href="#sales-tab" data-toggle="tab">Sales</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#services-tab" data-toggle="tab">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#customer-tab" data-toggle="tab">Customers</a>
            </li>
          </ul>
<!-- Sales Tab -->
<div class="tab-content">
<div id="sales-tab" class="tab-pane fade show active">
  <h3>Sales Report Summary</h3>
  <div class="form-group">
    <label for="interval-select">Select Report:</label>
    <select class="form-control" id="interval-select">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="Monthly">Monthly</option>
      <option value="Yearly">Yearly</option>
    </select>
  </div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Date</th>
        <th>Total Sales</th>
      </tr>
    </thead>
    <tbody id="sales-table-body">
    </tbody>
  </table>
    <!-- print report -->
    <button class="btn btn-primary" id="print-customer-report">Print Report</button>
</div>

<script>
$('#interval-select').on('change', function() {
  var interval = $(this).val();
  postData("http://localhost:3000/sales-data", { "interval": interval })
    .then(function(data) {
      console.log(data); // log the data to the console to check its contents
      var $salesTableBody = $('#sales-table-body');
      $salesTableBody.empty();
      if (data && data.length > 0) { // check that data is not empty and has at least one item
        $.each(data, function(index, row) {
          var $tr = $('<tr>');
          $tr.append($('<td>').text(row[0] + ' - ' + row[1]));
          $tr.append($('<td>').text(row[2]));
          $salesTableBody.append($tr);
        });
      } else {
        // handle empty or invalid data
        $salesTableBody.append($('<tr>').append($('<td>').text('No data available')));
      }
    })
    .catch(function(error) {
      console.error(error);
      // handle errors
      $('#sales-table-body').append($('<tr>').append($('<td>').text('Error: ' + error.message)));
    });
});


  async function postData(url = "", data) {
    const response = await fetch(url, {
      method: "POST",
      mode: "cors",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(data),
    });
    return response.json();
  }
</script>




<!-- Services Tab + filter by search by service: Still need to determine best way to report... drop down of services maybe? -->
<!-- Mockup of search bar only functions for daily and weekly -->
<div id="services-tab" class="tab-pane fade">
  <h3>Services Report Summary</h3>
  <div class="form-group">
    <label for="interval-select">Select Report:</label>
    <select class="form-control" id="services-interval-select">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="Monthly">Monthly</option>
      <option value="Yearly">Yearly</option>
    </select>
  </div>
  <div class="form-group">
    <label for="service-search">Search by Service Name:</label>
    <input type="text" class="form-control" id="service-search">
  </div>
  <div id="services-table-container"></div>
    <!-- print report -->
    <button class="btn btn-primary" id="print-customer-report">Print Report</button>
</div>

<script>
  // generate services table based on selected interval and search query ***dummy data***
  function generateServicesTable(interval, query) {
    var data;
    
    if (interval === "daily") {
      data = [
        { service: "Service A", quantity: 20, revenue: 400 },
        { service: "Service B", quantity: 15, revenue: 300 },
        { service: "Service C", quantity: 10, revenue: 200 }
      ];
    } else if (interval === "weekly") {
      data = [
        { service: "Service A", quantity: 140, revenue: 2800 },
        { service: "Service B", quantity: 105, revenue: 2100 },
        { service: "Service C", quantity: 70, revenue: 1400 }
      ];
    } else if (interval === "monthly") {
      data = [
        { service: "Service A", quantity: 500, revenue: 10000 },
        { service: "Service B", quantity: 350, revenue: 7000 },
        { service: "Service C", quantity: 200, revenue: 4000 }
      ];
    } else if (interval === "yearly") {
      data = [
        { service: "Service A", quantity: 6000, revenue: 120000 },
        { service: "Service B", quantity: 4200, revenue: 84000 },
        { service: "Service C", quantity: 2400, revenue: 48000 }
      ];
    } else {
      console.error("Invalid interval: " + interval);
      return;
    }
    
    // filter data by search query
    if (query) {
      data = data.filter(function(d) {
        return d.service.toLowerCase().indexOf(query.toLowerCase()) !== -1;
      });
    }
    
    // generate table HTML
    var tableHTML = "<table class='table'><thead><tr><th>Service Name</th><th># Customers</th><th>$ Order Amount</th></tr></thead><tbody>";
    for (var i = 0; i < data.length; i++) {
      tableHTML += "<tr><td>" + data[i].service + "</td><td>" + data[i].quantity + "</td><td>" + data[i].revenue + "</td></tr>";
    }
    tableHTML += "</tbody></table>";
    
    // render table
    $("#services-table-container").html(tableHTML);
  }
  
  $(document).ready(function() {
    // initial table
    generateServicesTable("daily", null);
    
    // update table when interval is changed
    $("#services-interval-select").change(function() {
      var interval = $(this).val();
      var query = $("#service-search").val();
      generateServicesTable(interval, query);
    });
    
    // update table when search query is entered
    $("#service-search").on("input", function() {
      var interval = $("#services-interval-select").val();
      var query = $(this).val();
      generateServicesTable(interval, query);
    });
  });

</script>
<!-- Customer Tab -->
<div id="customer-tab" class="tab-pane fade">
  <h3>Customer Report Summary</h3>
  <div class="form-group">
    <label for="customer-interval-select">Select Report:</label>
    <select class="form-control" id="customer-interval-select">
      <option value="daily">Daily</option>
      <option value="weekly">Weekly</option>
      <option value="Monthly">Monthly</option>
      <option value="Yearly">Yearly</option>
    </select>
  </div>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Date</th>
        <th>Last Name</th>
        <th>Middle Initial</th>
        <th>First Name</th>
        <th>Total Sales</th>
      </tr>
    </thead>
    <tbody id="customer-table-body">
    </tbody>
  </table>
  <!-- print report -->
  <button class="btn btn-primary" id="print-customer-report">Print Report</button>
</div>
<script>
  // populate the customer table with data based on the selected interval
  $('#customer-interval-select').on('change', function() {
    var interval = $(this).val();
    var customerData = getCustomerData(interval);
    var $customerTableBody = $('#customer-table-body');
    $customerTableBody.empty();
    $.each(customerData, function(index, row) {
      var $tr = $('<tr>');
      $tr.append($('<td>').text(row.date));  
      $tr.append($('<td>').text(row.lastName));
      $tr.append($('<td>').text(row.middleInitial));
      $tr.append($('<td>').text(row.firstName));
      $tr.append($('<td>').text(row.totalSales));
      $customerTableBody.append($tr);
    });
  });


 // simulate getting customer data from server based on the interval **dummy data**
function getCustomerData(interval) {
  var data = [];
  if (interval === 'daily') {
    data.push({date: '2023-04-07', lastName: 'Doe', middleInitial: 'A', firstName: 'John', totalSales: 100});
    data.push({date: '2023-04-07', lastName: 'Smith', middleInitial: 'B', firstName: 'Jane', totalSales: 200});
    data.push({date: '2023-04-07', lastName: 'Williams', middleInitial: 'C', firstName: 'Bob', totalSales: 300});
  } else if (interval === 'weekly') {
    data.push({date: '2023-04-01', lastName: 'Doe', middleInitial: 'A', firstName: 'John', totalSales: 500});
    data.push({date: '2023-04-01', lastName: 'Smith', middleInitial: 'B', firstName: 'Jane', totalSales: 1000});
    data.push({date: '2023-04-01', lastName: 'Williams', middleInitial: 'C', firstName: 'Bob', totalSales: 1500});
  } else if (interval === 'Monthly') {
    data.push({date: '2023-04-01', lastName: 'Doe', middleInitial: 'A', firstName: 'John', totalSales: 2000});
    data.push({date: '2023-04-01', lastName: 'Smith', middleInitial: 'B', firstName: 'Jane', totalSales: 2500});
    data.push({date: '2023-04-01', lastName: 'Williams', middleInitial: 'C', firstName: 'Bob', totalSales: 3000});
    data.push({date: '2023-03-01', lastName: 'Jones', middleInitial: 'D', firstName: 'Mike', totalSales: 3500});
    data.push({date: '2023-03-01', lastName: 'Davis', middleInitial: 'E', firstName: 'Kate', totalSales: 4000});
  } else if (interval === 'Yearly') {
    data.push({date: '2022-01-01', lastName: 'Doe', middleInitial: 'A', firstName: 'John', totalSales: 22000});
    data.push({date: '2022-01-01', lastName: 'Smith', middleInitial: 'B', firstName: 'Jane', totalSales: 24500});
    data.push({date: '2022-01-01', lastName: 'Williams', middleInitial: 'C', firstName: 'Bob', totalSales: 13000});
    data.push({date: '2022-01-01', lastName: 'Jones', middleInitial: 'D', firstName: 'Mike', totalSales: 35400});
    data.push({date: '2022-01-01', lastName: 'Davis', middleInitial: 'E', firstName: 'Kate', totalSales: 40200});
  }
  return data;
}

  

  //allows switching from sales to service tab
  $('.nav-link').click(function() {
    $('.nav-link').removeClass('active');
    $(this).addClass('active');
    var tabToShow = $(this).attr('href');
    $('.tab-pane').removeClass('show active');
    $(tabToShow).addClass('show active');
  });

</script>


      </div>
    </div>
  </body>
</html>